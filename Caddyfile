metsuke.app.br {
    # 1. API Backend
    handle /api/* {
        reverse_proxy backend:8080
    }

    # 2. Uploads Locais
    handle_path /uploads/* {
        root * /srv/uploads
        file_server
    }

    # 3. MÁGICA DO CACHE BUSTING
    # Proíbe o navegador de guardar a página inicial e o service worker no cache
    @nocache {
        path / /index.html /sw.js /manifest.json
    }
    header @nocache Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"

    # Permite cache longo para arquivos estáticos com hash no nome (Vite já faz isso)
    @static {
        path *.js *.css *.png *.jpg *.svg *.ico
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # 4. Frontend
    reverse_proxy frontend:80

    encode gzip
}

www.metsuke.app.br {
    redir https://metsuke.app.br{uri}
}